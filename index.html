<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor QR Code - Notas Fiscais</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .scanner-area {
            text-align: center;
            margin-bottom: 20px;
        }

        #qr-reader {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px 5px;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .btn-success {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
        }

        .category-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .category-item {
            background: linear-gradient(135deg, #667eea20, #764ba220);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .category-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .notes-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .note-item {
            background: #f8f9fa;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .note-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .note-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }

        .note-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
        }

        .note-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2ecc71;
        }

        .note-details {
            font-size: 0.9rem;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #333;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 8px;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-info {
            color: #1565c0;
            background-color: #e3f2fd;
            border-color: #90caf9;
        }

        .scanner-feedback {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .scan-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff6b6b;
            animation: pulse 1.5s infinite;
        }

        .status-indicator.scanning {
            background: #ffd93d;
        }

        .status-indicator.ready {
            background: #6bcf7f;
            animation: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        #qr-reader {
            border: 3px solid #667eea;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        #qr-reader video {
            border-radius: 12px;
        }

        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px dashed #667eea;
            border-radius: 15px;
            pointer-events: none;
            z-index: 10;
        }

        .scan-corners {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #667eea;
        }

        .scan-corners.top-left { top: 10px; left: 10px; border-right: none; border-bottom: none; }
        .scan-corners.top-right { top: 10px; right: 10px; border-left: none; border-bottom: none; }
        .scan-corners.bottom-left { bottom: 10px; left: 10px; border-right: none; border-top: none; }
        .scan-corners.bottom-right { bottom: 10px; right: 10px; border-left: none; border-top: none; }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .category-summary {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Leitor QR Code</h1>
            <p>Gerencie suas notas fiscais de forma inteligente</p>
        </div>

        <div class="dashboard">
            <!-- Scanner Card -->
            <div class="card">
                <h3>üì∑ Scanner QR Code</h3>
                <div class="scanner-area">
                    <div id="qr-reader" style="display: none;">
                        <div class="scan-overlay">
                            <div class="scan-corners top-left"></div>
                            <div class="scan-corners top-right"></div>
                            <div class="scan-corners bottom-left"></div>
                            <div class="scan-corners bottom-right"></div>
                        </div>
                    </div>
                    <button id="start-scan" class="btn">üì∑ Iniciar Scanner</button>
                    <button id="stop-scan" class="btn btn-danger" style="display: none;">‚èπÔ∏è Parar Scanner</button>
                    
                    <div class="scan-status" id="scan-status" style="display: none;">
                        <div class="status-indicator" id="status-indicator"></div>
                        <span id="status-text">Preparando c√¢mera...</span>
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Processando nota fiscal...</p>
                </div>
                
                <div id="alert-container"></div>
            </div>

            <!-- Resumo Mensal -->
            <div class="card">
                <h3>üìä Resumo do M√™s</h3>
                <div class="category-summary" id="monthly-summary">
                    <div class="category-item">
                        <div class="category-value" id="total-month">R$ 0,00</div>
                        <div>Total do M√™s</div>
                    </div>
                    <div class="category-item">
                        <div class="category-value" id="total-notes">0</div>
                        <div>Notas Cadastradas</div>
                    </div>
                </div>
            </div>

            <!-- Categorias -->
            <div class="card">
                <h3>üè∑Ô∏è Por Categoria</h3>
                <div class="category-summary" id="categories-summary">
                    <!-- Categorias ser√£o inseridas aqui -->
                </div>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Lista de Notas -->
        <div class="card">
            <h3>üìÑ Notas Fiscais Recentes</h3>
            <div class="notes-list" id="notes-list">
                <p style="text-align: center; color: #666; padding: 20px;">
                    Nenhuma nota fiscal cadastrada ainda.<br>
                    Use o scanner acima para come√ßar!
                </p>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div id="note-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="note-details"></div>
        </div>
    </div>

    <script>
        class NFManager {
            constructor() {
                this.notes = JSON.parse(localStorage.getItem('nf-notes') || '[]');
                this.html5QrCode = null;
                this.categories = {
                    'alimentacao': { name: 'Alimenta√ß√£o', color: '#e74c3c' },
                    'transporte': { name: 'Transporte', color: '#3498db' },
                    'lazer': { name: 'Lazer', color: '#9b59b6' },
                    'saude': { name: 'Sa√∫de', color: '#2ecc71' },
                    'educacao': { name: 'Educa√ß√£o', color: '#f39c12' },
                    'casa': { name: 'Casa/Utilidades', color: '#34495e' },
                    'roupas': { name: 'Vestu√°rio', color: '#e67e22' },
                    'outros': { name: 'Outros', color: '#95a5a6' }
                };
                this.chart = null;
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.updateDashboard();
                this.renderNotesList();
            }

            setupEventListeners() {
                document.getElementById('start-scan').addEventListener('click', () => this.startScanner());
                document.getElementById('stop-scan').addEventListener('click', () => this.stopScanner());
                
                // Modal events
                const modal = document.getElementById('note-modal');
                const closeBtn = document.querySelector('.close');
                
                closeBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                });
                
                window.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }

            async startScanner() {
                try {
                    console.log('üöÄ Iniciando scanner otimizado...');
                    
                    const qrReader = document.getElementById('qr-reader');
                    const scanStatus = document.getElementById('scan-status');
                    const statusIndicator = document.getElementById('status-indicator');
                    const statusText = document.getElementById('status-text');
                    
                    // Mostrar status
                    qrReader.style.display = 'block';
                    scanStatus.style.display = 'flex';
                    statusText.textContent = 'Preparando c√¢mera...';
                    statusIndicator.className = 'status-indicator';
                    
                    this.html5QrCode = new Html5Qrcode("qr-reader");
                    
                    // Configura√ß√µes otimizadas para melhor performance
                    const config = {
                        fps: 30, // FPS mais alto para detec√ß√£o r√°pida
                        qrbox: { width: 300, height: 300 }, // √Årea maior
                        aspectRatio: 1.0,
                        disableFlip: false,
                        experimentalFeatures: {
                            useBarCodeDetectorIfSupported: true // API nativa do browser
                        },
                        rememberLastUsedCamera: true,
                        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_QR_CODE]
                    };

                    const cameraConstraints = {
                        facingMode: "environment",
                        advanced: [
                            { focusMode: "continuous" },
                            { exposureMode: "continuous" },
                            { whiteBalanceMode: "continuous" }
                        ]
                    };
                    
                    // Atualizar status
                    statusText.textContent = 'Conectando √† c√¢mera...';
                    
                    await this.html5QrCode.start(
                        cameraConstraints,
                        config,
                        (qrCodeMessage) => {
                            console.log('üì± QR Code detectado instantaneamente:', qrCodeMessage);
                            
                            // Feedback visual imediato
                            statusIndicator.className = 'status-indicator ready';
                            statusText.textContent = '‚úÖ QR Code encontrado!';
                            
                            // Processar com pequeno delay para feedback visual
                            setTimeout(() => {
                                this.processQRCode(qrCodeMessage);
                            }, 500);
                        },
                        (errorMessage) => {
                            // Silenciar erros de scan, mas mostrar status
                            if (!statusText.textContent.includes('Aponte')) {
                                statusIndicator.className = 'status-indicator scanning';
                                statusText.textContent = 'üéØ Aponte para o QR Code';
                            }
                        }
                    );
                    
                    // Atualizar interface
                    document.getElementById('start-scan').style.display = 'none';
                    document.getElementById('stop-scan').style.display = 'inline-block';
                    
                    // Status final
                    statusIndicator.className = 'status-indicator scanning';
                    statusText.textContent = 'üéØ Aponte para o QR Code';
                    
                    // Adicionar dicas
                    this.showScanTips();
                    
                    console.log('‚úÖ Scanner iniciado com sucesso');
                    
                } catch (err) {
                    console.error('‚ùå Erro detalhado do scanner:', err);
                    
                    // Status de erro
                    const statusText = document.getElementById('status-text');
                    const statusIndicator = document.getElementById('status-indicator');
                    
                    statusIndicator.className = 'status-indicator';
                    statusText.textContent = '‚ùå Erro na c√¢mera';
                    
                    // Tentar fallback
                    try {
                        console.log('üîÑ Tentando configura√ß√£o simplificada...');
                        await this.startScannerFallback();
                    } catch (fallbackErr) {
                        this.showAlert('‚ùå N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes e tente novamente.', 'danger');
                        
                        // Resetar interface
                        document.getElementById('qr-reader').style.display = 'none';
                        document.getElementById('scan-status').style.display = 'none';
                        document.getElementById('start-scan').style.display = 'inline-block';
                        document.getElementById('stop-scan').style.display = 'none';
                    }
                }
            }

            async startScannerFallback() {
                console.log('üîÑ Iniciando scanner modo compatibilidade...');
                
                const statusText = document.getElementById('status-text');
                const statusIndicator = document.getElementById('status-indicator');
                
                statusText.textContent = 'Modo compatibilidade...';
                
                const config = {
                    fps: 15,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0
                };

                await this.html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    (qrCodeMessage) => {
                        console.log('üì± QR Code detectado (fallback):', qrCodeMessage);
                        
                        statusIndicator.className = 'status-indicator ready';
                        statusText.textContent = '‚úÖ QR Code encontrado!';
                        
                        setTimeout(() => {
                            this.processQRCode(qrCodeMessage);
                        }, 500);
                    },
                    (errorMessage) => {
                        statusIndicator.className = 'status-indicator scanning';
                        statusText.textContent = 'üéØ Aponte para o QR Code';
                    }
                );
                
                document.getElementById('start-scan').style.display = 'none';
                document.getElementById('stop-scan').style.display = 'inline-block';
                
                statusIndicator.className = 'status-indicator scanning';
                statusText.textContent = 'üéØ Aponte para o QR Code';
                
                this.showScanTips();
                console.log('‚úÖ Scanner fallback iniciado');
            }

            async stopScanner() {
                try {
                    if (this.html5QrCode) {
                        await this.html5QrCode.stop();
                        console.log('üì∑ Scanner parado');
                    }
                    
                    // Resetar interface
                    document.getElementById('qr-reader').style.display = 'none';
                    document.getElementById('scan-status').style.display = 'none';
                    document.getElementById('start-scan').style.display = 'inline-block';
                    document.getElementById('stop-scan').style.display = 'none';
                    
                    // Limpar alertas
                    const alertContainer = document.getElementById('alert-container');
                    if (alertContainer.innerHTML.includes('Dicas para melhor')) {
                        alertContainer.innerHTML = '';
                    }
                    
                } catch (err) {
                    console.log('Erro ao parar scanner:', err);
                }
            }

            async processQRCode(qrData) {
                try {
                    console.log('=== IN√çCIO DO PROCESSAMENTO ===');
                    console.log('QR Code Raw Data:', qrData);
                    console.log('Tamanho do QR:', qrData.length);
                    console.log('Tipo:', typeof qrData);
                    
                    await this.stopScanner();
                    this.showLoading(true);
                    
                    // Log detalhado da extra√ß√£o de dados
                    console.log('=== EXTRAINDO DADOS DO QR ===');
                    const noteData = await this.simulateSEFAZQuery(qrData);
                    
                    if (noteData) {
                        console.log('=== DADOS FINAIS EXTRA√çDOS ===');
                        console.log('Nota processada:', noteData);
                        this.addNote(noteData);
                        this.showAlert('Nota fiscal adicionada com sucesso!', 'success');
                    } else {
                        console.error('‚ùå Nenhum dado foi extra√≠do do QR Code');
                        this.showAlert('N√£o foi poss√≠vel extrair dados do QR Code', 'danger');
                    }
                    
                } catch (error) {
                    console.error('‚ùå ERRO NO PROCESSAMENTO:', error);
                    console.error('Stack trace:', error.stack);
                    this.showAlert('Erro ao processar QR Code: ' + error.message, 'danger');
                } finally {
                    this.showLoading(false);
                    console.log('=== FIM DO PROCESSAMENTO ===');
                }
            }

            async simulateSEFAZQuery(qrData) {
                try {
                    console.log('üîÑ INICIANDO simulateSEFAZQuery');
                    console.log('QR Data:', qrData);
                    
                    // Primeiro, tentar extrair dados do pr√≥prio QR Code
                    const extractedData = this.extractDataFromQR(qrData);
                    console.log('üìä Dados extra√≠dos:', extractedData);
                    
                    if (extractedData.chaveAcesso) {
                        console.log('‚úÖ Chave de acesso encontrada, consultando SEFAZ...');
                        
                        // Simular consulta real ao SEFAZ (delay realista)
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        // Em produ√ß√£o, faria requisi√ß√£o para: 
                        // https://www.sefaz.rs.gov.br/NFCE/NFCE-COM.aspx?chNFe=${chaveAcesso}
                        
                        const sefazData = await this.consultSEFAZ(extractedData.chaveAcesso);
                        console.log('üìã Dados do SEFAZ:', sefazData);
                        
                        const finalData = {
                            id: Date.now().toString(),
                            qrCode: qrData,
                            chaveAcesso: extractedData.chaveAcesso,
                            estabelecimento: sefazData.estabelecimento || 'Estabelecimento n√£o identificado',
                            valor: extractedData.valor || sefazData.valor || '0.00',
                            data: extractedData.data || new Date().toISOString().split('T')[0],
                            hora: extractedData.hora || new Date().toLocaleTimeString('pt-BR'),
                            categoria: this.categorizeByEstablishment(sefazData.estabelecimento),
                            cnpj: sefazData.cnpj || extractedData.cnpj || 'N√£o informado',
                            numeroNota: extractedData.numeroNota || sefazData.numeroNota || 'N√£o informado',
                            itens: sefazData.itens || this.generateMockItems(extractedData.valor),
                            uf: extractedData.uf || 'BR'
                        };
                        
                        console.log('‚úÖ DADOS FINAIS COMPILADOS:', finalData);
                        return finalData;
                        
                    } else {
                        console.log('‚ùå Nenhuma chave de acesso encontrada');
                        console.log('üîç Tentando interpretar como QR Code gen√©rico...');
                        
                        // Se n√£o encontrou chave, tentar extrair informa√ß√µes b√°sicas
                        const basicData = this.extractBasicInfo(qrData);
                        console.log('üìä Dados b√°sicos extra√≠dos:', basicData);
                        
                        if (basicData.hasValidInfo) {
                            return basicData;
                        } else {
                            throw new Error('QR Code n√£o cont√©m dados de nota fiscal v√°lidos. Formato n√£o reconhecido.');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå ERRO em simulateSEFAZQuery:', error);
                    throw new Error('Erro ao processar QR Code: ' + error.message);
                }
            }

            extractBasicInfo(qrData) {
                console.log('üîç EXTRAINDO INFORMA√á√ïES B√ÅSICAS DO QR');
                console.log('Analisando QR gen√©rico:', qrData);
                
                // Tentar encontrar padr√µes comuns
                const patterns = {
                    valor: [
                        /valor[:\s=]?R?\$?\s?([0-9]+[,.]?[0-9]*)/i,
                        /total[:\s=]?R?\$?\s?([0-9]+[,.]?[0-9]*)/i,
                        /([0-9]+[,.]?[0-9]*)\s?reais?/i,
                        /R\$\s?([0-9]+[,.]?[0-9]*)/i
                    ],
                    estabelecimento: [
                        /estabelecimento[:\s=]?([^|\n&]+)/i,
                        /empresa[:\s=]?([^|\n&]+)/i,
                        /loja[:\s=]?([^|\n&]+)/i
                    ],
                    cnpj: [
                        /cnpj[:\s=]?([0-9./-]+)/i,
                        /([0-9]{2}\.?[0-9]{3}\.?[0-9]{3}\/?[0-9]{4}-?[0-9]{2})/
                    ],
                    data: [
                        /data[:\s=]?([0-9]{1,2}[/-][0-9]{1,2}[/-][0-9]{2,4})/i,
                        /([0-9]{1,2}[/-][0-9]{1,2}[/-][0-9]{2,4})/,
                        /([0-9]{4}-[0-9]{2}-[0-9]{2})/
                    ]
                };
                
                const extracted = {
                    id: Date.now().toString(),
                    qrCode: qrData,
                    estabelecimento: 'Estabelecimento n√£o identificado',
                    valor: '0.00',
                    data: new Date().toISOString().split('T')[0],
                    hora: new Date().toLocaleTimeString('pt-BR'),
                    categoria: 'outros',
                    cnpj: 'N√£o informado',
                    numeroNota: 'N√£o informado',
                    itens: [],
                    uf: 'BR',
                    hasValidInfo: false
                };
                
                // Buscar valor
                for (const pattern of patterns.valor) {
                    const match = qrData.match(pattern);
                    if (match) {
                        extracted.valor = match[1].replace(',', '.');
                        extracted.hasValidInfo = true;
                        console.log('‚úÖ Valor encontrado:', extracted.valor);
                        break;
                    }
                }
                
                // Buscar estabelecimento
                for (const pattern of patterns.estabelecimento) {
                    const match = qrData.match(pattern);
                    if (match) {
                        extracted.estabelecimento = match[1].trim();
                        extracted.hasValidInfo = true;
                        console.log('‚úÖ Estabelecimento encontrado:', extracted.estabelecimento);
                        break;
                    }
                }
                
                // Buscar CNPJ
                for (const pattern of patterns.cnpj) {
                    const match = qrData.match(pattern);
                    if (match) {
                        extracted.cnpj = match[1];
                        extracted.hasValidInfo = true;
                        console.log('‚úÖ CNPJ encontrado:', extracted.cnpj);
                        break;
                    }
                }
                
                // Buscar data
                for (const pattern of patterns.data) {
                    const match = qrData.match(pattern);
                    if (match) {
                        extracted.data = this.parseDate(match[1]);
                        extracted.hasValidInfo = true;
                        console.log('‚úÖ Data encontrada:', extracted.data);
                        break;
                    }
                }
                
                // Se encontrou algo v√°lido, categorizar
                if (extracted.hasValidInfo) {
                    extracted.categoria = this.categorizeByEstablishment(extracted.estabelecimento);
                    extracted.itens = this.generateMockItems(extracted.valor);
                }
                
                console.log('üìã INFO B√ÅSICA FINAL:', extracted);
                return extracted;
            }

            parseDate(dateStr) {
                try {
                    // Tentar diferentes formatos de data
                    const formats = [
                        /([0-9]{1,2})[/-]([0-9]{1,2})[/-]([0-9]{4})/,  // dd/mm/yyyy
                        /([0-9]{4})-([0-9]{2})-([0-9]{2})/             // yyyy-mm-dd
                    ];
                    
                    for (const format of formats) {
                        const match = dateStr.match(format);
                        if (match) {
                            if (match[3] && match[3].length === 4) {
                                // dd/mm/yyyy
                                return `${match[3]}-${match[2].padStart(2, '0')}-${match[1].padStart(2, '0')}`;
                            } else {
                                // yyyy-mm-dd
                                return dateStr;
                            }
                        }
                    }
                } catch (e) {
                    console.log('Erro ao parsear data:', e);
                }
                return new Date().toISOString().split('T')[0];
            }

            extractDataFromQR(qrData) {
                console.log('üîç INICIANDO EXTRA√á√ÉO DE DADOS');
                console.log('QR Data recebido:', qrData);
                
                const extracted = {
                    chaveAcesso: null,
                    valor: null,
                    data: null,
                    hora: null,
                    cnpj: null,
                    numeroNota: null,
                    uf: null,
                    versaoQR: null,
                    tipoAmbiente: null
                };

                try {
                    console.log('üìã Analisando formato do QR Code...');
                    
                    // FORMATO 1: URL completa da SEFAZ
                    // https://www.sefaz.rs.gov.br/NFCE/NFCE-COM.aspx?chNFe=43210814200166000196650010000000046550000000
                    if (qrData.includes('sefaz') && qrData.includes('chNFe=')) {
                        console.log('‚úÖ Formato: URL SEFAZ com chNFe');
                        const chaveMatch = qrData.match(/chNFe=([A-Fa-f0-9]{44})/);
                        if (chaveMatch) {
                            extracted.chaveAcesso = chaveMatch[1];
                            console.log('‚úÖ Chave extra√≠da da URL:', extracted.chaveAcesso);
                        }
                    }
                    
                    // FORMATO 2: QR Code 2.0 da NFCe 4.0 - ONLINE
                    // http://www.sefaz.rs.gov.br/nfce/qrcode?p=chave|2|1
                    else if (qrData.includes('/nfce/qrcode') && qrData.includes('?p=')) {
                        console.log('‚úÖ Formato: QR Code 2.0 NFCe 4.0');
                        const paramsMatch = qrData.match(/\?p=([^&]+)/);
                        
                        if (paramsMatch) {
                            const params = paramsMatch[1].split('|');
                            console.log('üìä Par√¢metros encontrados:', params);
                            
                            if (params.length >= 3) {
                                extracted.chaveAcesso = params[0];
                                extracted.versaoQR = params[1];
                                extracted.tipoAmbiente = params[2];
                                
                                console.log('‚úÖ Dados QR 2.0:');
                                console.log('  Chave:', extracted.chaveAcesso);
                                console.log('  Vers√£o:', extracted.versaoQR);
                                console.log('  Ambiente:', extracted.tipoAmbiente);
                                
                                // OFFLINE (conting√™ncia) tem mais par√¢metros
                                if (params.length >= 6) {
                                    console.log('üì± QR Code OFFLINE detectado');
                                    // params[3] = dia da emiss√£o (DD)
                                    // params[4] = valor total
                                    // params[5] = digest value (pode ter mais ap√≥s)
                                    
                                    const diaEmissao = params[3];
                                    extracted.valor = params[4];
                                    
                                    console.log('üí∞ Valor extra√≠do (offline):', extracted.valor);
                                    console.log('üìÖ Dia emiss√£o:', diaEmissao);
                                    
                                    // Tentar construir data aproximada
                                    if (diaEmissao && diaEmissao.length === 2) {
                                        const hoje = new Date();
                                        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                                        const ano = hoje.getFullYear();
                                        extracted.data = `${ano}-${mes}-${diaEmissao}`;
                                    }
                                }
                            }
                        }
                    }
                    
                    // FORMATO 3: QR Code vers√£o 3.0 (mais novo)
                    // http://www.sefaz.rs.gov.br/nfce/qrcode?p=chave|3|1
                    else if (qrData.includes('qrcode') && qrData.includes('|3|')) {
                        console.log('‚úÖ Formato: QR Code 3.0 detectado');
                        const paramsMatch = qrData.match(/\?p=([^&]+)/);
                        
                        if (paramsMatch) {
                            const params = paramsMatch[1].split('|');
                            console.log('üìä Par√¢metros QR 3.0:', params);
                            
                            if (params.length >= 3) {
                                extracted.chaveAcesso = params[0];
                                extracted.versaoQR = params[1];
                                extracted.tipoAmbiente = params[2];
                                
                                // Vers√£o 3.0 offline tem formato espec√≠fico
                                if (params.length >= 8) {
                                    extracted.valor = params[4]; // vNF
                                    console.log('üí∞ Valor QR 3.0:', extracted.valor);
                                }
                            }
                        }
                    }
                    
                    // FORMATO 4: QR Code antigo com par√¢metros separados
                    // chNFe=...&vNF=...&dhEmi=...
                    else if (qrData.includes('&')) {
                        console.log('‚úÖ Formato: Par√¢metros URL separados');
                        
                        const chaveMatch = qrData.match(/chNFe=([A-Fa-f0-9]{44})/);
                        if (chaveMatch) {
                            extracted.chaveAcesso = chaveMatch[1];
                        }
                        
                        const valorMatch = qrData.match(/vNF=([0-9.,]+)/);
                        if (valorMatch) {
                            extracted.valor = valorMatch[1].replace(',', '.');
                            console.log('üí∞ Valor extra√≠do:', extracted.valor);
                        }
                        
                        const dhEmiMatch = qrData.match(/dhEmi=([^&]+)/);
                        if (dhEmiMatch) {
                            try {
                                const dhEmiDecoded = decodeURIComponent(dhEmiMatch[1]);
                                console.log('üïê Data/hora decodificada:', dhEmiDecoded);
                                
                                const dataHora = dhEmiDecoded.split('T');
                                if (dataHora.length === 2) {
                                    extracted.data = dataHora[0];
                                    extracted.hora = dataHora[1].split('-')[0];
                                }
                            } catch (e) {
                                console.log('‚ùå Erro ao decodificar dhEmi:', e);
                            }
                        }
                    }
                    
                    // FORMATO 5: Apenas sequ√™ncia de 44 d√≠gitos (chave pura)
                    else {
                        console.log('üîç Tentando extrair chave direta...');
                        const hexPattern = /[A-Fa-f0-9]{44}/;
                        const match = qrData.match(hexPattern);
                        
                        if (match) {
                            extracted.chaveAcesso = match[0];
                            console.log('‚úÖ Chave encontrada (formato direto):', extracted.chaveAcesso);
                        }
                    }
                    
                    // Se encontrou chave, extrair dados dela
                    if (extracted.chaveAcesso && extracted.chaveAcesso.length === 44) {
                        console.log('üîë Processando chave de acesso...');
                        
                        const uf = extracted.chaveAcesso.substring(0, 2);
                        const anoMes = extracted.chaveAcesso.substring(2, 8);
                        const cnpjChave = extracted.chaveAcesso.substring(8, 22);
                        const numeroNF = extracted.chaveAcesso.substring(25, 34);
                        
                        extracted.uf = this.getUFName(uf);
                        extracted.cnpj = this.formatCNPJ(cnpjChave);
                        extracted.numeroNota = parseInt(numeroNF).toString();
                        
                        // Extrair data da chave se n√£o foi encontrada antes
                        if (!extracted.data && anoMes.length === 6) {
                            const ano = '20' + anoMes.substring(0, 2);
                            const mes = anoMes.substring(2, 4);
                            const dia = anoMes.substring(4, 6) || '01';
                            extracted.data = `${ano}-${mes}-${dia}`;
                        }
                        
                        console.log('üìä Dados extra√≠dos da chave:');
                        console.log('  UF:', extracted.uf);
                        console.log('  CNPJ:', extracted.cnpj);
                        console.log('  N√∫mero NF:', extracted.numeroNota);
                        console.log('  Data:', extracted.data);
                    }

                } catch (error) {
                    console.error('‚ùå Erro ao extrair dados do QR:', error);
                }
                
                console.log('üìã DADOS EXTRA√çDOS FINAL:');
                console.log(extracted);
                
                return extracted;
            }

            getUFName(codigo) {
                const ufs = {
                    '11': 'RO', '12': 'AC', '13': 'AM', '14': 'RR', '15': 'PA', '16': 'AP', '17': 'TO',
                    '21': 'MA', '22': 'PI', '23': 'CE', '24': 'RN', '25': 'PB', '26': 'PE', '27': 'AL', '28': 'SE', '29': 'BA',
                    '31': 'MG', '32': 'ES', '33': 'RJ', '35': 'SP',
                    '41': 'PR', '42': 'SC', '43': 'RS',
                    '50': 'MS', '51': 'MT', '52': 'GO', '53': 'DF'
                };
                return ufs[codigo] || codigo;
            }

            formatCNPJ(cnpj) {
                // Formatar CNPJ: 12345678000195 -> 12.345.678/0001-95
                if (cnpj.length === 14) {
                    return cnpj.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                }
                return cnpj;
            }

            async consultSEFAZ(chaveAcesso) {
                // Em produ√ß√£o, aqui faria a consulta real ao SEFAZ
                // Por enquanto, simular com base na chave de acesso
                
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Simular dados baseados na chave
                const uf = chaveAcesso.substring(0, 2);
                const cnpjChave = chaveAcesso.substring(8, 22);
                
                return {
                    estabelecimento: this.getEstablishmentByCNPJ(cnpjChave),
                    cnpj: this.formatCNPJ(cnpjChave),
                    valor: (Math.random() * 200 + 10).toFixed(2),
                    numeroNota: parseInt(chaveAcesso.substring(25, 34)).toString(),
                    itens: this.generateRealisticItems(),
                    uf: this.getUFName(uf)
                };
            }

            getEstablishmentByCNPJ(cnpj) {
                // Mapear alguns CNPJs conhecidos para estabelecimentos reais
                const establishments = {
                    '47508411000135': 'Extra Supermercados',
                    '47960950000114': 'Carrefour',
                    '17351074000118': 'Walmart Brasil',
                    '33014556000196': 'Casas Bahia',
                    '59291534000107': 'Magazine Luiza',
                    '33000167000101': 'P√£o de A√ß√∫car'
                };
                
                return establishments[cnpj] || this.generateRandomEstablishment();
            }

            generateRealisticItems() {
                const products = [
                    { nome: 'Arroz Branco 5kg', quantidade: 1, valor: '22.90' },
                    { nome: 'Feij√£o Preto 1kg', quantidade: 2, valor: '8.50' },
                    { nome: '√ìleo de Soja 900ml', quantidade: 1, valor: '6.90' },
                    { nome: 'A√ß√∫car Cristal 1kg', quantidade: 1, valor: '4.20' },
                    { nome: 'Caf√© Torrado 500g', quantidade: 1, valor: '12.80' },
                    { nome: 'Leite Integral 1L', quantidade: 3, valor: '4.50' },
                    { nome: 'P√£o de Forma', quantidade: 1, valor: '5.90' },
                    { nome: 'Margarina 500g', quantidade: 1, valor: '7.20' }
                ];
                
                const numItems = Math.floor(Math.random() * 5) + 1;
                return products.slice(0, numItems);
            }

            generateMockItems(totalValue) {
                if (!totalValue) return this.generateRealisticItems();
                
                const value = parseFloat(totalValue);
                const numItems = Math.floor(Math.random() * 3) + 1;
                const itemValue = (value / numItems).toFixed(2);
                
                return Array.from({length: numItems}, (_, i) => ({
                    nome: `Item ${i + 1}`,
                    quantidade: 1,
                    valor: itemValue
                }));
            }

            categorizeByEstablishment(establishment) {
                if (!establishment) return 'outros';
                
                const name = establishment.toLowerCase();
                
                if (name.includes('supermercado') || name.includes('mercado') || 
                    name.includes('extra') || name.includes('carrefour') || 
                    name.includes('p√£o de a√ß√∫car')) {
                    return 'alimentacao';
                }
                
                if (name.includes('posto') || name.includes('shell') || 
                    name.includes('petrobras') || name.includes('ipiranga')) {
                    return 'transporte';
                }
                
                if (name.includes('farm√°cia') || name.includes('drogaria')) {
                    return 'saude';
                }
                
                if (name.includes('livraria') || name.includes('cultura') || 
                    name.includes('escola') || name.includes('curso')) {
                    return 'educacao';
                }
                
                if (name.includes('magazine') || name.includes('casas bahia') || 
                    name.includes('lojas')) {
                    return 'casa';
                }
                
                if (name.includes('restaurant') || name.includes('lanchonete') || 
                    name.includes('pizza') || name.includes('mcdonald')) {
                    return 'lazer';
                }
                
                return 'outros';
            }

            generateRandomEstablishment() {
                const establishments = [
                    'Supermercado Bom Pre√ßo',
                    'Posto Shell',
                    'McDonald\'s',
                    'Farm√°cia Drogasil',
                    'Livraria Cultura',
                    'C&A',
                    'Magazine Luiza',
                    'Restaurante Sabor Caseiro'
                ];
                return establishments[Math.floor(Math.random() * establishments.length)];
            }

            generateRandomCNPJ() {
                return '12.345.678/0001-90';
            }

            generateRandomItems() {
                const items = [
                    { nome: 'Produto A', quantidade: 1, valor: '25.50' },
                    { nome: 'Produto B', quantidade: 2, valor: '15.00' },
                    { nome: 'Produto C', quantidade: 1, valor: '8.90' }
                ];
                return items.slice(0, Math.floor(Math.random() * 3) + 1);
            }

            categorizeAutomatically() {
                const categories = Object.keys(this.categories);
                return categories[Math.floor(Math.random() * categories.length)];
            }

            addNote(noteData) {
                this.notes.unshift(noteData);
                this.saveNotes();
                this.updateDashboard();
                this.renderNotesList();
            }

            deleteNote(noteId) {
                this.notes = this.notes.filter(note => note.id !== noteId);
                this.saveNotes();
                this.updateDashboard();
                this.renderNotesList();
                this.showAlert('Nota fiscal removida!', 'success');
            }

            saveNotes() {
                localStorage.setItem('nf-notes', JSON.stringify(this.notes));
            }

            updateDashboard() {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                const monthlyNotes = this.notes.filter(note => {
                    const noteDate = new Date(note.data);
                    return noteDate.getMonth() === currentMonth && noteDate.getFullYear() === currentYear;
                });

                const totalMonth = monthlyNotes.reduce((sum, note) => sum + parseFloat(note.valor), 0);
                
                document.getElementById('total-month').textContent = `R$ ${totalMonth.toFixed(2).replace('.', ',')}`;
                document.getElementById('total-notes').textContent = monthlyNotes.length;

                this.updateCategorySummary(monthlyNotes);
                this.updateChart(monthlyNotes);
            }

            updateCategorySummary(notes) {
                const categoryTotals = {};
                
                Object.keys(this.categories).forEach(cat => {
                    categoryTotals[cat] = 0;
                });

                notes.forEach(note => {
                    categoryTotals[note.categoria] += parseFloat(note.valor);
                });

                const summaryContainer = document.getElementById('categories-summary');
                summaryContainer.innerHTML = '';

                Object.entries(categoryTotals).forEach(([category, total]) => {
                    if (total > 0) {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'category-item';
                        categoryDiv.innerHTML = `
                            <div class="category-value">R$ ${total.toFixed(2).replace('.', ',')}</div>
                            <div>${this.categories[category].name}</div>
                        `;
                        summaryContainer.appendChild(categoryDiv);
                    }
                });
            }

            updateChart(notes) {
                const categoryTotals = {};
                
                notes.forEach(note => {
                    if (!categoryTotals[note.categoria]) {
                        categoryTotals[note.categoria] = 0;
                    }
                    categoryTotals[note.categoria] += parseFloat(note.valor);
                });

                const ctx = document.getElementById('categoryChart').getContext('2d');
                
                if (this.chart) {
                    this.chart.destroy();
                }

                const labels = Object.keys(categoryTotals).map(cat => this.categories[cat].name);
                const data = Object.values(categoryTotals);
                const colors = Object.keys(categoryTotals).map(cat => this.categories[cat].color);

                this.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            renderNotesList() {
                const notesList = document.getElementById('notes-list');
                
                if (this.notes.length === 0) {
                    notesList.innerHTML = `
                        <p style="text-align: center; color: #666; padding: 20px;">
                            Nenhuma nota fiscal cadastrada ainda.<br>
                            Use o scanner acima para come√ßar!
                        </p>
                    `;
                    return;
                }

                notesList.innerHTML = this.notes.map(note => `
                    <div class="note-item" onclick="nfManager.showNoteDetails('${note.id}')">
                        <div class="note-header">
                            <span class="note-title">${note.estabelecimento}</span>
                            <span class="note-value">R$ ${parseFloat(note.valor).toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="note-details">
                            ${new Date(note.data).toLocaleDateString('pt-BR')} - ${this.categories[note.categoria].name}
                        </div>
                    </div>
                `).join('');
            }

            showNoteDetails(noteId) {
                const note = this.notes.find(n => n.id === noteId);
                if (!note) return;

                const modal = document.getElementById('note-modal');
                const detailsContainer = document.getElementById('note-details');
                
                detailsContainer.innerHTML = `
                    <h2>üìÑ Detalhes da Nota Fiscal</h2>
                    <div style="margin: 20px 0;">
                        <p><strong>Estabelecimento:</strong> ${note.estabelecimento}</p>
                        <p><strong>CNPJ:</strong> ${note.cnpj}</p>
                        ${note.chaveAcesso ? `<p><strong>Chave de Acesso:</strong> ${note.chaveAcesso}</p>` : ''}
                        <p><strong>Data:</strong> ${new Date(note.data).toLocaleDateString('pt-BR')}</p>
                        <p><strong>Hora:</strong> ${note.hora}</p>
                        <p><strong>Valor Total:</strong> R$ ${parseFloat(note.valor).toFixed(2).replace('.', ',')}</p>
                        <p><strong>Categoria:</strong> ${this.categories[note.categoria].name}</p>
                        <p><strong>N√∫mero da Nota:</strong> ${note.numeroNota}</p>
                        ${note.uf ? `<p><strong>UF:</strong> ${note.uf}</p>` : ''}
                    </div>
                    
                    <h3>üõí Itens</h3>
                    <div style="margin: 15px 0;">
                        ${note.itens.map(item => `
                            <p>‚Ä¢ ${item.nome} - Qtd: ${item.quantidade} - R$ ${item.valor}</p>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button class="btn btn-success" onclick="nfManager.shareNote('${note.id}')">
                            üì± Compartilhar no WhatsApp
                        </button>
                        <button class="btn" onclick="nfManager.downloadNotePDF('${note.id}')">
                            üì• Download PDF
                        </button>
                        <button class="btn btn-danger" onclick="nfManager.deleteNote('${note.id}'); document.getElementById('note-modal').style.display='none';">
                            üóëÔ∏è Excluir Nota
                        </button>
                    </div>
                `;
                
                modal.style.display = 'block';
            }

            shareNote(noteId) {
                const note = this.notes.find(n => n.id === noteId);
                if (!note) return;

                const message = `üìÑ *Nota Fiscal*\n\n` +
                              `üè™ ${note.estabelecimento}\n` +
                              `üí∞ R$ ${parseFloat(note.valor).toFixed(2).replace('.', ',')}\n` +
                              `üìÖ ${new Date(note.data).toLocaleDateString('pt-BR')}\n` +
                              `üè∑Ô∏è ${this.categories[note.categoria].name}`;

                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }

            downloadNotePDF(noteId) {
                const note = this.notes.find(n => n.id === noteId);
                if (!note) return;

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(20);
                doc.text('Nota Fiscal', 20, 30);
                
                doc.setFontSize(12);
                doc.text(`Estabelecimento: ${note.estabelecimento}`, 20, 50);
                doc.text(`CNPJ: ${note.cnpj}`, 20, 60);
                doc.text(`Data: ${new Date(note.data).toLocaleDateString('pt-BR')}`, 20, 70);
                doc.text(`Hora: ${note.hora}`, 20, 80);
                doc.text(`Valor Total: R$ ${parseFloat(note.valor).toFixed(2).replace('.', ',')}`, 20, 90);
                doc.text(`Categoria: ${this.categories[note.categoria].name}`, 20, 100);
                doc.text(`N√∫mero da Nota: ${note.numeroNota}`, 20, 110);

                doc.text('Itens:', 20, 130);
                let yPos = 140;
                note.itens.forEach(item => {
                    doc.text(`${item.nome} - Qtd: ${item.quantidade} - R$ ${item.valor}`, 20, yPos);
                    yPos += 10;
                });

                doc.save(`nota-fiscal-${note.numeroNota}.pdf`);
            }

            showAlert(message, type) {
                const alertContainer = document.getElementById('alert-container');
                alertContainer.innerHTML = `
                    <div class="alert alert-${type}">
                        ${message}
                    </div>
                `;
                
                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 5000);
            }

            showLoading(show) {
                const loading = document.getElementById('loading');
                loading.style.display = show ? 'block' : 'none';
            }
        }

        // Inicializar o app
        let nfManager;
        
        document.addEventListener('DOMContentLoaded', function() {
            nfManager = new NFManager();
            
            // Adicionar algumas notas de exemplo para demonstra√ß√£o
            if (nfManager.notes.length === 0) {
                const exampleNotes = [
                    {
                        id: '1',
                        estabelecimento: 'Supermercado Central',
                        valor: '85.50',
                        data: new Date().toISOString().split('T')[0],
                        hora: '14:30:00',
                        categoria: 'alimentacao',
                        cnpj: '12.345.678/0001-90',
                        numeroNota: 123456,
                        itens: [
                            { nome: 'Arroz 5kg', quantidade: 1, valor: '25.50' },
                            { nome: 'Feij√£o 1kg', quantidade: 2, valor: '15.00' },
                            { nome: '√ìleo de soja', quantidade: 1, valor: '8.90' }
                        ]
                    },
                    {
                        id: '2',
                        estabelecimento: 'Posto Ipiranga',
                        valor: '120.00',
                        data: new Date(Date.now() - 86400000).toISOString().split('T')[0],
                        hora: '09:15:00',
                        categoria: 'transporte',
                        cnpj: '98.765.432/0001-10',
                        numeroNota: 654321,
                        itens: [
                            { nome: 'Gasolina Comum', quantidade: 25, valor: '120.00' }
                        ]
                    }
                ];
                
                nfManager.notes = exampleNotes;
                nfManager.saveNotes();
                nfManager.updateDashboard();
                nfManager.renderNotesList();
            }
        });
    </script>
</body>
</html>
