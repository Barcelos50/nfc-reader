<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor QR Code - Notas Fiscais</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .scanner-area {
            text-align: center;
            margin-bottom: 20px;
        }

        #qr-reader {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px 5px;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .btn-success {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
        }

        .category-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .category-item {
            background: linear-gradient(135deg, #667eea20, #764ba220);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .category-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .notes-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .note-item {
            background: #f8f9fa;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .note-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .note-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }

        .note-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
        }

        .note-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2ecc71;
        }

        .note-details {
            font-size: 0.9rem;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #333;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 8px;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .category-summary {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Leitor QR Code</h1>
            <p>Gerencie suas notas fiscais de forma inteligente</p>
        </div>

        <div class="dashboard">
            <!-- Scanner Card -->
            <div class="card">
                <h3>üì∑ Scanner QR Code</h3>
                <div class="scanner-area">
                    <div id="qr-reader" style="display: none;"></div>
                    <button id="start-scan" class="btn">Iniciar Scanner</button>
                    <button id="stop-scan" class="btn btn-danger" style="display: none;">Parar Scanner</button>
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Processando nota fiscal...</p>
                </div>
                
                <div id="alert-container"></div>
            </div>

            <!-- Resumo Mensal -->
            <div class="card">
                <h3>üìä Resumo do M√™s</h3>
                <div class="category-summary" id="monthly-summary">
                    <div class="category-item">
                        <div class="category-value" id="total-month">R$ 0,00</div>
                        <div>Total do M√™s</div>
                    </div>
                    <div class="category-item">
                        <div class="category-value" id="total-notes">0</div>
                        <div>Notas Cadastradas</div>
                    </div>
                </div>
            </div>

            <!-- Categorias -->
            <div class="card">
                <h3>üè∑Ô∏è Por Categoria</h3>
                <div class="category-summary" id="categories-summary">
                    <!-- Categorias ser√£o inseridas aqui -->
                </div>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Lista de Notas -->
        <div class="card">
            <h3>üìÑ Notas Fiscais Recentes</h3>
            <div class="notes-list" id="notes-list">
                <p style="text-align: center; color: #666; padding: 20px;">
                    Nenhuma nota fiscal cadastrada ainda.<br>
                    Use o scanner acima para come√ßar!
                </p>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div id="note-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="note-details"></div>
        </div>
    </div>

    <script>
        class NFManager {
            constructor() {
                this.notes = JSON.parse(localStorage.getItem('nf-notes') || '[]');
                this.html5QrCode = null;
                this.categories = {
                    'alimentacao': { name: 'Alimenta√ß√£o', color: '#e74c3c' },
                    'transporte': { name: 'Transporte', color: '#3498db' },
                    'lazer': { name: 'Lazer', color: '#9b59b6' },
                    'saude': { name: 'Sa√∫de', color: '#2ecc71' },
                    'educacao': { name: 'Educa√ß√£o', color: '#f39c12' },
                    'casa': { name: 'Casa/Utilidades', color: '#34495e' },
                    'roupas': { name: 'Vestu√°rio', color: '#e67e22' },
                    'outros': { name: 'Outros', color: '#95a5a6' }
                };
                this.chart = null;
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.updateDashboard();
                this.renderNotesList();
            }

            setupEventListeners() {
                document.getElementById('start-scan').addEventListener('click', () => this.startScanner());
                document.getElementById('stop-scan').addEventListener('click', () => this.stopScanner());
                
                // Modal events
                const modal = document.getElementById('note-modal');
                const closeBtn = document.querySelector('.close');
                
                closeBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                });
                
                window.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }

            async startScanner() {
                try {
                    const qrReader = document.getElementById('qr-reader');
                    qrReader.style.display = 'block';
                    
                    this.html5QrCode = new Html5Qrcode("qr-reader");
                    
                    await this.html5QrCode.start(
                        { facingMode: "environment" },
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        (qrCodeMessage) => {
                            this.processQRCode(qrCodeMessage);
                        },
                        (errorMessage) => {
                            // Ignore scan errors
                        }
                    );
                    
                    document.getElementById('start-scan').style.display = 'none';
                    document.getElementById('stop-scan').style.display = 'inline-block';
                    
                } catch (err) {
                    this.showAlert('Erro ao iniciar scanner: ' + err.message, 'danger');
                }
            }

            async stopScanner() {
                if (this.html5QrCode) {
                    await this.html5QrCode.stop();
                    document.getElementById('qr-reader').style.display = 'none';
                    document.getElementById('start-scan').style.display = 'inline-block';
                    document.getElementById('stop-scan').style.display = 'none';
                }
            }

            async processQRCode(qrData) {
                try {
                    await this.stopScanner();
                    this.showLoading(true);
                    
                    // Simular consulta SEFAZ (em produ√ß√£o, faria requisi√ß√£o real)
                    const noteData = await this.simulateSEFAZQuery(qrData);
                    
                    if (noteData) {
                        this.addNote(noteData);
                        this.showAlert('Nota fiscal adicionada com sucesso!', 'success');
                    }
                    
                } catch (error) {
                    this.showAlert('Erro ao processar QR Code: ' + error.message, 'danger');
                } finally {
                    this.showLoading(false);
                }
            }

            async simulateSEFAZQuery(qrData) {
                // Simular delay de requisi√ß√£o
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Extrair dados b√°sicos do QR (formato simplificado)
                const mockData = {
                    id: Date.now().toString(),
                    qrCode: qrData,
                    estabelecimento: this.generateRandomEstablishment(),
                    valor: (Math.random() * 500 + 10).toFixed(2),
                    data: new Date().toISOString().split('T')[0],
                    hora: new Date().toLocaleTimeString('pt-BR'),
                    categoria: this.categorizeAutomatically(),
                    cnpj: this.generateRandomCNPJ(),
                    numeroNota: Math.floor(Math.random() * 999999) + 100000,
                    itens: this.generateRandomItems()
                };

                return mockData;
            }

            generateRandomEstablishment() {
                const establishments = [
                    'Supermercado Bom Pre√ßo',
                    'Posto Shell',
                    'McDonald\'s',
                    'Farm√°cia Drogasil',
                    'Livraria Cultura',
                    'C&A',
                    'Magazine Luiza',
                    'Restaurante Sabor Caseiro'
                ];
                return establishments[Math.floor(Math.random() * establishments.length)];
            }

            generateRandomCNPJ() {
                return '12.345.678/0001-90';
            }

            generateRandomItems() {
                const items = [
                    { nome: 'Produto A', quantidade: 1, valor: '25.50' },
                    { nome: 'Produto B', quantidade: 2, valor: '15.00' },
                    { nome: 'Produto C', quantidade: 1, valor: '8.90' }
                ];
                return items.slice(0, Math.floor(Math.random() * 3) + 1);
            }

            categorizeAutomatically() {
                const categories = Object.keys(this.categories);
                return categories[Math.floor(Math.random() * categories.length)];
            }

            addNote(noteData) {
                this.notes.unshift(noteData);
                this.saveNotes();
                this.updateDashboard();
                this.renderNotesList();
            }

            deleteNote(noteId) {
                this.notes = this.notes.filter(note => note.id !== noteId);
                this.saveNotes();
                this.updateDashboard();
                this.renderNotesList();
                this.showAlert('Nota fiscal removida!', 'success');
            }

            saveNotes() {
                localStorage.setItem('nf-notes', JSON.stringify(this.notes));
            }

            updateDashboard() {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                const monthlyNotes = this.notes.filter(note => {
                    const noteDate = new Date(note.data);
                    return noteDate.getMonth() === currentMonth && noteDate.getFullYear() === currentYear;
                });

                const totalMonth = monthlyNotes.reduce((sum, note) => sum + parseFloat(note.valor), 0);
                
                document.getElementById('total-month').textContent = `R$ ${totalMonth.toFixed(2).replace('.', ',')}`;
                document.getElementById('total-notes').textContent = monthlyNotes.length;

                this.updateCategorySummary(monthlyNotes);
                this.updateChart(monthlyNotes);
            }

            updateCategorySummary(notes) {
                const categoryTotals = {};
                
                Object.keys(this.categories).forEach(cat => {
                    categoryTotals[cat] = 0;
                });

                notes.forEach(note => {
                    categoryTotals[note.categoria] += parseFloat(note.valor);
                });

                const summaryContainer = document.getElementById('categories-summary');
                summaryContainer.innerHTML = '';

                Object.entries(categoryTotals).forEach(([category, total]) => {
                    if (total > 0) {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'category-item';
                        categoryDiv.innerHTML = `
                            <div class="category-value">R$ ${total.toFixed(2).replace('.', ',')}</div>
                            <div>${this.categories[category].name}</div>
                        `;
                        summaryContainer.appendChild(categoryDiv);
                    }
                });
            }

            updateChart(notes) {
                const categoryTotals = {};
                
                notes.forEach(note => {
                    if (!categoryTotals[note.categoria]) {
                        categoryTotals[note.categoria] = 0;
                    }
                    categoryTotals[note.categoria] += parseFloat(note.valor);
                });

                const ctx = document.getElementById('categoryChart').getContext('2d');
                
                if (this.chart) {
                    this.chart.destroy();
                }

                const labels = Object.keys(categoryTotals).map(cat => this.categories[cat].name);
                const data = Object.values(categoryTotals);
                const colors = Object.keys(categoryTotals).map(cat => this.categories[cat].color);

                this.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            renderNotesList() {
                const notesList = document.getElementById('notes-list');
                
                if (this.notes.length === 0) {
                    notesList.innerHTML = `
                        <p style="text-align: center; color: #666; padding: 20px;">
                            Nenhuma nota fiscal cadastrada ainda.<br>
                            Use o scanner acima para come√ßar!
                        </p>
                    `;
                    return;
                }

                notesList.innerHTML = this.notes.map(note => `
                    <div class="note-item" onclick="nfManager.showNoteDetails('${note.id}')">
                        <div class="note-header">
                            <span class="note-title">${note.estabelecimento}</span>
                            <span class="note-value">R$ ${parseFloat(note.valor).toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="note-details">
                            ${new Date(note.data).toLocaleDateString('pt-BR')} - ${this.categories[note.categoria].name}
                        </div>
                    </div>
                `).join('');
            }

            showNoteDetails(noteId) {
                const note = this.notes.find(n => n.id === noteId);
                if (!note) return;

                const modal = document.getElementById('note-modal');
                const detailsContainer = document.getElementById('note-details');
                
                detailsContainer.innerHTML = `
                    <h2>üìÑ Detalhes da Nota Fiscal</h2>
                    <div style="margin: 20px 0;">
                        <p><strong>Estabelecimento:</strong> ${note.estabelecimento}</p>
                        <p><strong>CNPJ:</strong> ${note.cnpj}</p>
                        <p><strong>Data:</strong> ${new Date(note.data).toLocaleDateString('pt-BR')}</p>
                        <p><strong>Hora:</strong> ${note.hora}</p>
                        <p><strong>Valor Total:</strong> R$ ${parseFloat(note.valor).toFixed(2).replace('.', ',')}</p>
                        <p><strong>Categoria:</strong> ${this.categories[note.categoria].name}</p>
                        <p><strong>N√∫mero da Nota:</strong> ${note.numeroNota}</p>
                    </div>
                    
                    <h3>üõí Itens</h3>
                    <div style="margin: 15px 0;">
                        ${note.itens.map(item => `
                            <p>${item.nome} - Qtd: ${item.quantidade} - R$ ${item.valor}</p>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button class="btn btn-success" onclick="nfManager.shareNote('${note.id}')">
                            üì± Compartilhar no WhatsApp
                        </button>
                        <button class="btn" onclick="nfManager.downloadNotePDF('${note.id}')">
                            üì• Download PDF
                        </button>
                        <button class="btn btn-danger" onclick="nfManager.deleteNote('${note.id}'); document.getElementById('note-modal').style.display='none';">
                            üóëÔ∏è Excluir Nota
                        </button>
                    </div>
                `;
                
                modal.style.display = 'block';
            }

            shareNote(noteId) {
                const note = this.notes.find(n => n.id === noteId);
                if (!note) return;

                const message = `üìÑ *Nota Fiscal*\n\n` +
                              `üè™ ${note.estabelecimento}\n` +
                              `üí∞ R$ ${parseFloat(note.valor).toFixed(2).replace('.', ',')}\n` +
                              `üìÖ ${new Date(note.data).toLocaleDateString('pt-BR')}\n` +
                              `üè∑Ô∏è ${this.categories[note.categoria].name}`;

                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }

            downloadNotePDF(noteId) {
                const note = this.notes.find(n => n.id === noteId);
                if (!note) return;

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(20);
                doc.text('Nota Fiscal', 20, 30);
                
                doc.setFontSize(12);
                doc.text(`Estabelecimento: ${note.estabelecimento}`, 20, 50);
                doc.text(`CNPJ: ${note.cnpj}`, 20, 60);
                doc.text(`Data: ${new Date(note.data).toLocaleDateString('pt-BR')}`, 20, 70);
                doc.text(`Hora: ${note.hora}`, 20, 80);
                doc.text(`Valor Total: R$ ${parseFloat(note.valor).toFixed(2).replace('.', ',')}`, 20, 90);
                doc.text(`Categoria: ${this.categories[note.categoria].name}`, 20, 100);
                doc.text(`N√∫mero da Nota: ${note.numeroNota}`, 20, 110);

                doc.text('Itens:', 20, 130);
                let yPos = 140;
                note.itens.forEach(item => {
                    doc.text(`${item.nome} - Qtd: ${item.quantidade} - R$ ${item.valor}`, 20, yPos);
                    yPos += 10;
                });

                doc.save(`nota-fiscal-${note.numeroNota}.pdf`);
            }

            showAlert(message, type) {
                const alertContainer = document.getElementById('alert-container');
                alertContainer.innerHTML = `
                    <div class="alert alert-${type}">
                        ${message}
                    </div>
                `;
                
                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 5000);
            }

            showLoading(show) {
                const loading = document.getElementById('loading');
                loading.style.display = show ? 'block' : 'none';
            }
        }

        // Inicializar o app
        let nfManager;
        
        document.addEventListener('DOMContentLoaded', function() {
            nfManager = new NFManager();
            
            // Adicionar algumas notas de exemplo para demonstra√ß√£o
            if (nfManager.notes.length === 0) {
                const exampleNotes = [
                    {
                        id: '1',
                        estabelecimento: 'Supermercado Central',
                        valor: '85.50',
                        data: new Date().toISOString().split('T')[0],
                        hora: '14:30:00',
                        categoria: 'alimentacao',
                        cnpj: '12.345.678/0001-90',
                        numeroNota: 123456,
                        itens: [
                            { nome: 'Arroz 5kg', quantidade: 1, valor: '25.50' },
                            { nome: 'Feij√£o 1kg', quantidade: 2, valor: '15.00' },
                            { nome: '√ìleo de soja', quantidade: 1, valor: '8.90' }
                        ]
                    },
                    {
                        id: '2',
                        estabelecimento: 'Posto Ipiranga',
                        valor: '120.00',
                        data: new Date(Date.now() - 86400000).toISOString().split('T')[0],
                        hora: '09:15:00',
                        categoria: 'transporte',
                        cnpj: '98.765.432/0001-10',
                        numeroNota: 654321,
                        itens: [
                            { nome: 'Gasolina Comum', quantidade: 25, valor: '120.00' }
                        ]
                    }
                ];
                
                nfManager.notes = exampleNotes;
                nfManager.saveNotes();
                nfManager.updateDashboard();
                nfManager.renderNotesList();
            }
        });
    </script>
</body>
</html>
